<!DOCTYPE html>
<html>
    <head id="head-id">

        <script src="/dist/main.js"></script>
        <script>
            
            const { dom } = wq;
            // ----------------------
            dom.ready( () => {
                console.log( 'DOM ready!' ); 
            } );
            // ----------------------
            wq.MutationObserver.attr( document.head, record => {
                //console.log( '=============>>>>>>>>>>>===attr', record );
            } );
            document.head.setAttribute( 'hfhfhfh', 'jjjjjjjj' );
            // ----------------------





            /**
             * Generates an alphanumeric unique id
             */
             const uniqId = () => (0|Math.random()*9e6).toString(36);

            /**
             * Interceptions
             */

            // ------------------
            // Sees all already handled interceptions
            const handled = node => {
                // If programmatically added, handled by the append()/appendChild() interceptors,
                // and this would be the "delayed capture" by the Mutation Observer 
                // If captured from the input stream, handled by the Mutation Observer
                // Or this might just be a reentry whatever the initial case
            };
            // ------------------
            // JAVASCRIPT::[CONTRACT]([SCOPED])?
            const handleContractJS = (node, isScoped) => {
            };
            // ------------------
            // JAVASCRIPT::[SCOPED]
            const handleScopedJS = node => {
                let rawSource = node.textContent, importsArea;
                // ---------
                // Rewrite module scripts? hard!
                if ( node.getAttribute( 'type' )?.toLowerCase() === 'module' ) {
                    // ---------
                    const rewrite = ( imports, body ) => {
                        // Rewrite as scoped
                        const uiid = uniqId();
                        node.toggleAttribute( `scoped-${ uiid }`, true );
                        node.textContent = `${ imports }
                        (function() {
                            ${ body }
                        }).call(document.querySelector('script[scoped-${ uiid }]').parentNode);`;
                    }
                    // ---------
                    if ( !rawSource.includes( 'import ') ) {
                        return rewrite( '', node.textContent );
                    }
                    // ---------
                    const lastI = rawSource.length - 1;
                    // Match import statements
                    const [ tokens ] = [ ...rawSource ].reduce( ( [ splits, meta ], char, i ) => {
                        if ( meta.openImport === 'closing' && (
                            char === ';'/* explicit */ || ![ ' ', `\n` ].includes( char )/* implicit */ || i === lastI/* eof */
                        ) ) {
                            if ( char === ';' || i === lastI ) {
                                splits[ 0 ] += char;
                                splits.unshift( '' );
                            } else { splits.unshift( char ); }
                            meta.openImport = null;
                        } else {
                            if ( meta.openQuote === char ) {
                                meta.openQuote = null;
                                if ( meta.openImport ) { meta.openImport = 'closing'; }
                            } else if ( !meta.openQuote ) {
                                if ( !meta.openImport && rawSource.substring( i ).trim().startsWith( 'import ' ) ) {
                                    meta.openImport = true;
                                    splits.unshift( '' );
                                } else if ( [ '"', "'", "`" ].includes( char ) ) {
                                    meta.openQuote = char;
                                }
                            }
                            splits[ 0 ] += char;
                        }
                        return [ splits, meta ];
                    }, [ [ '' ], {} ] );
                    // Hoist all import statements
                    let imports = '', body = '', _str;
                    for ( const str of tokens.reverse() ) {
                        if ( ( _str = str.trim() ).startsWith( 'import ' ) || ( !imports && !_str ) ) {
                            imports += str;
                        } else { body += str; }
                    }
                    return rewrite( imports, body );
                }
                // ---------
                // Rewrite classic scripts. easy!
                node.textContent = `(function() {
                    ${ node.textContent }
                }).call(document.currentScript.parentNode);`;
            };
            // ------------------
            // (STYLE|LINK[REL=STYLESHEET])::[SCOPED]
            const handleScopedCSS = (node, isExtStylesheet) => {
                const uiid = uniqId();
                node.toggleAttribute( `scoped-${ uiid }`, true );
                const sheet = new CSSStyleSheet;
                sheet.replaceSync( node.textContent );
                for ( let k = 0; k < sheet.cssRules.length; k ++ ) {
                    const cssRule = sheet.cssRules[k];
                    console.log('--------------', cssRule);
                }
                //node.textContent = `[scoped-css-id="${ ref }"]${ node.textContent }`;
            };
            // ------------------
            // TEMPLATE::[NAME]([SCOPED])?
            const handleTemplate = (node, templateName, isScoped) => {
            };

            /**
             * 
             */
            const intercept = (node, type) => {
                let isScript, isStylesheet, isExtStylesheet, isTemplate, templateName, isScoped;
                if ((isTemplate = (node.tagName === 'TEMPLATE' && (templateName = node.getAttribute('name'))))
                || (isScript = (node.tagName === 'SCRIPT'))
                || (isStylesheet = (node.tagName === 'STYLE'))
                || (isStylesheet = (node.tagName === 'LINK' 
                    && (isExtStylesheet = (node.getAttribute('rel')?.toLowerCase() === 'stylesheet'))
                ))) {
                    let isContractJS = isScript && node.hasAttribute('contract');
                    if (isScoped = node.hasAttribute('scoped')) {
                        if (node.scoped) return handled(node);
                        Object.defineProperty(node, 'scoped', { value: true, configurable: false });
                        // JAVASCRIPT::[SCOPED]
                        if (isScript && !isContractJS) { handleScopedJS(node); }
                        // (STYLE|LINK[REL=STYLESHEET])::[SCOPED]
                        else if (isStylesheet) { handleScopedCSS(node, isExtStylesheet); }
                    }
                    if (isTemplate) {
                        if (node.name) return handled(node);
                        Object.defineProperty(node, 'name', { value: true, configurable: false });
                        // TEMPLATE::[NAME]([SCOPED])?
                        handleTemplate(node, templateName, isScoped);
                    }
                    if (isScript && isContractJS) {
                        if (node.contract) return handled(node);
                        Object.defineProperty(node, 'contract', { value: true, configurable: false });
                        // JAVASCRIPT::[CONTRACT]([SCOPED])?
                        handleContractJS(node, isScoped);
                    }
                }
            }




            wq.MutationObserver.intercept( document, 'script[scoped]', record => {
                record.incomingNodes.forEach( script => {
                    intercept( script );
                } );
            }, { subtree: true } );
        </script>

        <script type="hfhfh">

            /**
             * Generates an alphanumeric unique id
             */
            const uniqId = () => (0|Math.random()*9e6).toString(36);

            /**
             * Interceptions
             */

            // ------------------
            // Sees all already handled interceptions
            const handled = node => {
                // If programmatically added, handled by the append()/appendChild() interceptors,
                // and this would be the "delayed capture" by the Mutation Observer 
                // If captured from the input stream, handled by the Mutation Observer
                // Or this might just be a reentry whatever the initial case
            };
            // ------------------
            // JAVASCRIPT::[CONTRACT]([SCOPED])?
            const handleContractJS = (node, isScoped) => {
            };
            // ------------------
            // JAVASCRIPT::[SCOPED]
            const handleScopedJS = node => {
                let rawSource = node.textContent, importsArea;
                // ---------
                // Rewrite module scripts? hard!
                if ( node.getAttribute( 'type' )?.toLowerCase() === 'module' ) {
                    // ---------
                    const rewrite = ( imports, body ) => {
                        // Rewrite as scoped
                        const uiid = uniqId();
                        node.toggleAttribute( `scoped-${ uiid }`, true );
                        node.textContent = `${ imports }
                        (function() {
                            ${ body }
                        }).call(document.querySelector('script[scoped-${ uiid }]').parentNode);`;
                    }
                    // ---------
                    if ( !rawSource.includes( 'import ') ) {
                        return rewrite( '', node.textContent );
                    }
                    // ---------
                    const lastI = rawSource.length - 1;
                    // Match import statements
                    const [ tokens ] = [ ...rawSource ].reduce( ( [ splits, meta ], char, i ) => {
                        if ( meta.openImport === 'closing' && (
                            char === ';'/* explicit */ || ![ ' ', `\n` ].includes( char )/* implicit */ || i === lastI/* eof */
                        ) ) {
                            if ( char === ';' || i === lastI ) {
                                splits[ 0 ] += char;
                                splits.unshift( '' );
                            } else { splits.unshift( char ); }
                            meta.openImport = null;
                        } else {
                            if ( meta.openQuote === char ) {
                                meta.openQuote = null;
                                if ( meta.openImport ) { meta.openImport = 'closing'; }
                            } else if ( !meta.openQuote ) {
                                if ( !meta.openImport && rawSource.substring( i ).trim().startsWith( 'import ' ) ) {
                                    meta.openImport = true;
                                    splits.unshift( '' );
                                } else if ( [ '"', "'", "`" ].includes( char ) ) {
                                    meta.openQuote = char;
                                }
                            }
                            splits[ 0 ] += char;
                        }
                        return [ splits, meta ];
                    }, [ [ '' ], {} ] );
                    // Hoist all import statements
                    let imports = '', body = '', _str;
                    for ( const str of tokens.reverse() ) {
                        if ( ( _str = str.trim() ).startsWith( 'import ' ) || ( !imports && !_str ) ) {
                            imports += str;
                        } else { body += str; }
                    }
                    return rewrite( imports, body );
                }
                // ---------
                // Rewrite classic scripts. easy!
                node.textContent = `(function() {
                    ${ node.textContent }
                }).call(document.currentScript.parentNode);`;
            };
            // ------------------
            // (STYLE|LINK[REL=STYLESHEET])::[SCOPED]
            const handleScopedCSS = (node, isExtStylesheet) => {
                const uiid = uniqId();
                node.toggleAttribute( `scoped-${ uiid }`, true );
                const sheet = new CSSStyleSheet;
                sheet.replaceSync( node.textContent );
                for ( let k = 0; k < sheet.cssRules.length; k ++ ) {
                    const cssRule = sheet.cssRules[k];
                    console.log('--------------', cssRule);
                }
                //node.textContent = `[scoped-css-id="${ ref }"]${ node.textContent }`;
            };
            // ------------------
            // TEMPLATE::[NAME]([SCOPED])?
            const handleTemplate = (node, templateName, isScoped) => {
            };

            /**
             * 
             */
            const intercept = (node, type) => {
                let isScript, isStylesheet, isExtStylesheet, isTemplate, templateName, isScoped;
                if ((isTemplate = (node.tagName === 'TEMPLATE' && (templateName = node.getAttribute('name'))))
                || (isScript = (node.tagName === 'SCRIPT'))
                || (isStylesheet = (node.tagName === 'STYLE'))
                || (isStylesheet = (node.tagName === 'LINK' 
                    && (isExtStylesheet = (node.getAttribute('rel')?.toLowerCase() === 'stylesheet'))
                ))) {
                    let isContractJS = isScript && node.hasAttribute('contract');
                    if (isScoped = node.hasAttribute('scoped')) {
                        if (node.scoped) return handled(node);
                        Object.defineProperty(node, 'scoped', { value: true, configurable: false });
                        // JAVASCRIPT::[SCOPED]
                        if (isScript && !isContractJS) { handleScopedJS(node); }
                        // (STYLE|LINK[REL=STYLESHEET])::[SCOPED]
                        else if (isStylesheet) { handleScopedCSS(node, isExtStylesheet); }
                    }
                    if (isTemplate) {
                        if (node.name) return handled(node);
                        Object.defineProperty(node, 'name', { value: true, configurable: false });
                        // TEMPLATE::[NAME]([SCOPED])?
                        handleTemplate(node, templateName, isScoped);
                    }
                    if (isScript && isContractJS) {
                        if (node.contract) return handled(node);
                        Object.defineProperty(node, 'contract', { value: true, configurable: false });
                        // JAVASCRIPT::[CONTRACT]([SCOPED])?
                        handleContractJS(node, isScoped);
                    }
                }
            }
            const interceptDeep = (node, apiName) => {
                let _node, walker = document.createTreeWalker(node, NodeFilter.SHOW_ELEMENT);
                while(_node = walker.nextNode()) { intercept(_node, apiName); }
                intercept(node, apiName);
            };

            /**
             * 
             */
            const undoIntercept = (node, type) => {
            }

            /**
             * 
             */
            (new MutationObserver((mutationList, observer) => {
                for (const mutation of mutationList) {
                    for (const node of mutation.addedNodes) { intercept(node, 'parse-stream'); }
                    for (const node of mutation.removedNodes) { undoIntercept(node, 'parse-stream'); }
                }
            })).observe(document, { childList: true, subtree: true });

            /**
             * 
             */
            ['append', 'prepend'].forEach(apiName => {
                const originalApi = document[apiName];
                document[apiName] = function(...args) {
                    if (this.isConnected)
                    for (const node of args) {
                        if (!(typeof node === 'object' && node)) continue;
                        interceptDeep(node, apiName);
                    }
                    return originalApi.call(document, ...args);
                }
            });
            ['before', 'after', 'append', 'prepend', 'appendChild', 'prependChild', 'replaceWith',
            'replaceChildren', 'replaceChild', 'insertBefore', 'insertAdjacentElement'].forEach(apiName => {
                const irrelevantArgIndex = ['replaceChild', 'insertBefore'].includes(apiName) ? 1 
                    : (apiName === 'insertAdjacentElement' ? 0 : null);
                const originalApi = Element.prototype[apiName];
                Element.prototype[apiName] = function(...args) {
                    if (this.isConnected)
                    for (const node of args) {
                        if (irrelevantArgIndex !== null && node === args[irrelevantArgIndex]) continue;
                        if (!(typeof node === 'object' && node)) continue;
                        interceptDeep(node, apiName);
                    }
                    return originalApi.call(this, ...args);
                }
            });
        </script>

        <script scoped>
            console.log('--------------------scoped------------------------------------', this.id)
        </script>
        <script type="module" scoped c-ontract>
            import 'https://unpkg.com/@webqit/oohtml/dist/main.js'
            ; import * as oohmtl from 'https://unpkg.com/@webqit/oohtml/dist/main.js'
            ;
            console.log('-----------------------scoped module, with imports---------------------------------', this?.id);
            import * as oohmktl from 'https://unpkg.com/@webqit/oohtml/dist/main.js';

        </script>


        <title>Hello</title>
        <link rel="styesheet" href="/my-styles.css" />
        <style>
            @media all and (max-width: 750px) {
                header {
                    background-color: blue;
                }
            }
        </style>

        <template name="header"><div>header content</div></template>
        <template name="footer"><div>footer content</div></template>
        <script src="https://unpkg.com/@webqit/oohtml/dist/html-imports.js"></script>
    </head>
    <body id="body-id">


        <import template="header">Default content</import>
        <import template="footer">Default content</import>


        <script scoped>
            console.log('-----------------------scoped---------------------------------', this.id);
            let div0 = document.createElement('div');
            let div = document.createElement('div');
            div.setAttribute('id', 'divdivdivdivdivdiv');
            let script = document.createElement('script', { is: 'a-b' });
            script.toggleAttribute('scoped', true);
            script.setAttribute('type', 'module');
            script.innerHTML = "console.log('dynamically-added//////////scoped module///////////', this.id);";
            div.appendChild(script);
            div0.appendChild(div);
            document.body.appendChild(script);
        </script>

        <header id="some-header">
            Some content
            <ul id="some-ul" style="list-style: none; display: flex;">
                <li><a href="/">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/contact">Contact</a></li>
            </ul>
        </header>

        <header id="some-id" class="header-section" style="background-color: rgb(8, 8, 1);">
            <nav class="nav-box">
                <ul style="list-style: none; display: flex;">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about">About</a></li>
                    <li><a href="/contact">Contact</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <div class="generic-container" style="display: flex;">
                <div class="content" id="content-area">
                    <h1 style="color: red; font-size: 40px;">Hi, I'm Oxford Harrison!</h1>
                    <p>
                        I am a web developer and JavaScript engineer! I have come to my 10th year in the game!
                        I would like you to take a look at my protfolio! Do reach out and hire me!
                        <style scoped>
                            :scope {
                                background-color: red;
                            }
                            @media (max-width: 600px) {
                                .facet_sidebar {
                                    display: none;
                                }
                            }
                        </style>
                        <dialog open>
                            <p>Greetings, one and all!</p>
                            <form method="dialog">
                              <button>OK</button>
                            </form>
                          </dialog>
                    </p>
                </div>
                <div id="sidebar">
                </div>
            </div>
        </main>

        <footer>
            <ul>
                <li><a href="/">Twitter</a></li>
                <li><a href="/about">Facebook</a></li>
                <li><a href="/contact">Instagram</a></li>
            </ul>
        </footer>
    </body>
</html>
